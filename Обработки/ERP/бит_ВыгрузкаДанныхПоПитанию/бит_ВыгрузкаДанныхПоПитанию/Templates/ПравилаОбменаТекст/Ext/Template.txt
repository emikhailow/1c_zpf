<ПравилаОбмена>
	<ВерсияФормата РежимСовместимости="РежимСовместимостиСБСП20">2.01</ВерсияФормата>
	<Ид>2df6b3e2-9229-4b04-b0ac-9906936f4d3f    </Ид>
	<Наименование>УправлениеПредприятием --&gt; ЗарплатаИУправлениеПерсоналом (ZEL-204)</Наименование>
	<ДатаВремяСоздания>2022-03-22T17:51:18</ДатаВремяСоздания>
	<Источник ВерсияПлатформы="8.0" ВерсияКонфигурации="2.5.6.244" СинонимКонфигурации="1С:ERP Управление предприятием 2">УправлениеПредприятием</Источник>
	<Приемник ВерсияПлатформы="8.0" ВерсияКонфигурации="3.1.20.97" СинонимКонфигурации="Зарплата и управление персоналом, редакция 3.1">ЗарплатаИУправлениеПерсоналом</Приемник>
	<Параметры>
		<Параметр Имя="Склад                                             " Наименование="Склад" ИспользуетсяПриЗагрузке="false" УстанавливатьВДиалоге="true" ТипЗначения="СправочникСсылка.Склады" ПередаватьПараметрПриВыгрузке="false"/>
		<Параметр Имя="Склады                                            " Наименование="Склады" ИспользуетсяПриЗагрузке="false" УстанавливатьВДиалоге="true" ТипЗначения="Строка" ПередаватьПараметрПриВыгрузке="false"/>
	</Параметры>
	<Обработки/>
	<ПравилаКонвертацииОбъектов>
		<Правило>
			<Код>бит_ОплатаПитания</Код>
			<Наименование>:</Наименование>
			<Порядок>50</Порядок>
			<ПослеЗагрузки>Запрос = Новый Запрос;
Запрос.Текст = 
"ВЫБРАТЬ
|	бит_КартыСотрудников.Карта КАК Карта,
|	МАКСИМУМ(бит_КартыСотрудников.Период) КАК Период
|ПОМЕСТИТЬ ВТМаксПериод
|ИЗ
|	РегистрСведений.бит_КартыСотрудников КАК бит_КартыСотрудников
|ГДЕ
|	бит_КартыСотрудников.Период &lt; &amp;Дата
|	И бит_КартыСотрудников.Карта = &amp;Карта

|СГРУППИРОВАТЬ ПО
|	бит_КартыСотрудников.Карта
|;

|////////////////////////////////////////////////////////////////////////////////
|ВЫБРАТЬ
|	бит_КартыСотрудников.Сотрудник.Код КАК ТабНомер,
|	бит_КартыСотрудников.Сотрудник КАК Сотрудник
|ИЗ
|	РегистрСведений.бит_КартыСотрудников КАК бит_КартыСотрудников
|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТМаксПериод КАК ВТМаксПериод
|		ПО бит_КартыСотрудников.Период = ВТМаксПериод.Период
|			И бит_КартыСотрудников.Карта = ВТМаксПериод.Карта
|ГДЕ
|	бит_КартыСотрудников.Активна = ИСТИНА";
Запрос.УстановитьПараметр("Дата", 	Объект.ПериодЗаписи);
Запрос.УстановитьПараметр("Карта", 	ПараметрыОбъекта["НомерПлатежнойКарты"]);

РезультатЗапроса = Запрос.Выполнить();
ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
	
	Объект.Сотрудник 	= ВыборкаДетальныеЗаписи.Сотрудник;
	Объект.ТабНомер 	= ВыборкаДетальныеЗаписи.ТабНомер;
	
КонецЦикла;

Сообщить(Объект.ПериодЗаписи);
Сообщить(ПараметрыОбъекта["НомерПлатежнойКарты"]);
Сообщить(Объект.Сотрудник);

Если Не ЗначениеЗаполнено(Объект.Сотрудник) Тогда
	
	ТекстОшибки = "По номеру карты " + ПараметрыОбъекта["НомерПлатежнойКарты"] + " сотрудник не найден! Запись будет пропущена!";
	
	Сообщить(ТекстОшибки);
	ЗаписьЖурналаРегистрации("Выгрузка данных по питанию (БИТ)", 
	УровеньЖурналаРегистрации.Ошибка, 
	РегистрыСведений.бит_ОплатаПитания,, 
	ТекстОшибки);
	
	Отказ = Истина;
	
Иначе
	
	НаборЗаписей = РегистрыСведений.бит_ОплатаПитания.СоздатьНаборЗаписей();
	НаборЗаписей.Отбор.ПериодЗаписи.Установить(Объект.ПериодЗаписи);
	НаборЗаписей.Отбор.Сотрудник.Установить(Объект.Сотрудник);
	НаборЗаписей.Отбор.ОРП.Установить(Объект.ОРП);
	
	НоваяЗапись 				= НаборЗаписей.Добавить();
	НоваяЗапись.ПериодЗаписи 	= Объект.ПериодЗаписи;
	НоваяЗапись.Сотрудник 		= Объект.Сотрудник;
	НоваяЗапись.ТабНомер 		= Объект.ТабНомер;
	НоваяЗапись.ОРП 			= Объект.ОРП;
	НоваяЗапись.Сумма 			= Объект.Сумма;
	НоваяЗапись.Активность 		= Объект.Активность;
	
	НаборЗаписей.Записать();
	
КонецЕсли;</ПослеЗагрузки>
			<НеЗапоминатьВыгруженные>true</НеЗапоминатьВыгруженные>
			<Приемник>РегистрСведенийЗапись.бит_ОплатаПитания</Приемник>
			<Свойства>
				<Свойство>
					<Код>1</Код>
					<Наименование>--&gt; ОРП</Наименование>
					<Порядок>50</Порядок>
					<ПолучитьИзВходящихДанных>true</ПолучитьИзВходящихДанных>
					<Источник Имя="" Вид=""/>
					<Приемник Имя="ОРП" Вид="Измерение" Тип="Строка"/>
				</Свойство>
				<Свойство>
					<Код>2</Код>
					<Наименование>--&gt; ПериодЗаписи</Наименование>
					<Порядок>100</Порядок>
					<ПолучитьИзВходящихДанных>true</ПолучитьИзВходящихДанных>
					<Источник Имя="" Вид=""/>
					<Приемник Имя="ПериодЗаписи" Вид="Измерение" Тип="Дата"/>
				</Свойство>
				<Свойство>
					<Код>3</Код>
					<Наименование>--&gt; НомерПлатежнойКарты</Наименование>
					<Порядок>150</Порядок>
					<Источник Имя="" Вид=""/>
					<Приемник Имя="" Вид=""/>
					<ИмяПараметраДляПередачи>НомерПлатежнойКарты</ИмяПараметраДляПередачи>
					<ПередВыгрузкой>Значение = ВходящиеДанные.НомерПлатежнойКарты</ПередВыгрузкой>
				</Свойство>
				<Свойство>
					<Код>4</Код>
					<Наименование>--&gt; ТабНомер</Наименование>
					<Порядок>200</Порядок>
					<Источник Имя="" Вид=""/>
					<Приемник Имя="ТабНомер" Вид="Измерение" Тип="Строка"/>
				</Свойство>
				<Свойство>
					<Код>5</Код>
					<Наименование>--&gt; Сумма</Наименование>
					<Порядок>250</Порядок>
					<ПолучитьИзВходящихДанных>true</ПолучитьИзВходящихДанных>
					<Источник Имя="" Вид=""/>
					<Приемник Имя="Сумма" Вид="Ресурс" Тип="Число"/>
				</Свойство>
				<Свойство>
					<Код>6</Код>
					<Наименование>--&gt; Активность</Наименование>
					<Порядок>300</Порядок>
					<Источник Имя="" Вид=""/>
					<Приемник Имя="Активность" Вид="Свойство" Тип="Булево"/>
					<ПередВыгрузкой>Значение = Истина;</ПередВыгрузкой>
				</Свойство>
			</Свойства>
			<Значения/>
		</Правило>
	</ПравилаКонвертацииОбъектов>
	<ПравилаВыгрузкиДанных>
		<Правило Отключить="false">
			<Код>ОтчетОРозничныхПродажах_ОплатаПитания</Код>
			<Наименование>Отчет о розничных продажах -&gt; Оплата питания</Наименование>
			<Порядок>150</Порядок>
			<СпособОтбораДанных>ПроизвольныйАлгоритм</СпособОтбораДанных>
			<ОбъектВыборки>ДокументСсылка.ОтчетОРозничныхПродажах</ОбъектВыборки>
			<ПередОбработкойПравила>
Запрос = Новый Запрос("ВЫБРАТЬ
|	ОтчетОРозничныхПродажахбитзпф_ОплатаПрочимиТипами.Ссылка.Дата КАК Период,
|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ОтчетОРозничныхПродажахбитзпф_ОплатаПрочимиТипами.Ссылка) КАК ОРП,
|	ОтчетОРозничныхПродажахбитзпф_ОплатаПрочимиТипами.НомерКарты КАК НомерКарты,
|	СУММА(ОтчетОРозничныхПродажахбитзпф_ОплатаПрочимиТипами.Сумма) КАК Сумма
|ИЗ
|	Документ.ОтчетОРозничныхПродажах.битзпф_ОплатаПрочимиТипами КАК ОтчетОРозничныхПродажахбитзпф_ОплатаПрочимиТипами
|ГДЕ
|	ОтчетОРозничныхПродажахбитзпф_ОплатаПрочимиТипами.Ссылка.Дата МЕЖДУ &amp;ДатаНачала И &amp;ДатаОкончания
|	И ОтчетОРозничныхПродажахбитзпф_ОплатаПрочимиТипами.Ссылка.Проведен
|	И ОтчетОРозничныхПродажахбитзпф_ОплатаПрочимиТипами.Ссылка.Склад В ИЕРАРХИИ(&amp;Склады)
|
|СГРУППИРОВАТЬ ПО
|	ОтчетОРозничныхПродажахбитзпф_ОплатаПрочимиТипами.Ссылка,
|	ОтчетОРозничныхПродажахбитзпф_ОплатаПрочимиТипами.Ссылка.Дата,
|	ОтчетОРозничныхПродажахбитзпф_ОплатаПрочимиТипами.НомерКарты,
|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ОтчетОРозничныхПродажахбитзпф_ОплатаПрочимиТипами.Ссылка)");

Запрос.УстановитьПараметр("Склады", ЗначениеИзСтрокиВнутр(Параметры.Склады));
Запрос.УстановитьПараметр("ДатаНачала", ДатаНачала);
Запрос.УстановитьПараметр("ДатаОкончания", ДатаОкончания);

Выборка = Запрос.Выполнить().Выбрать();
Пока Выборка.Следующий() Цикл
	Если ЗначениеЗаполнено(Выборка.НомерКарты) Тогда
		ВходящиеДанные = Новый Структура("ПериодЗаписи, ОРП, НомерПлатежнойКарты, Сумма", Выборка.Период, Выборка.ОРП, Выборка.НомерКарты, Выборка.Сумма);
		ВыгрузитьПоПравилу( , , ВходящиеДанные, , "бит_ОплатаПитания");
	КонецЕсли;
КонецЦикла;</ПередОбработкойПравила>
		</Правило>
	</ПравилаВыгрузкиДанных>
	<ПравилаОчисткиДанных/>
	<Алгоритмы>
		<Алгоритм Имя="СоздатьЗаписьРегистраОплатаПитания" ИспользуетсяПриЗагрузке="true"/>
	</Алгоритмы>
	<Запросы/>
</ПравилаОбмена>