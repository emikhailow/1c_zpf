<ПравилаОбмена>
	<ВерсияФормата РежимСовместимости="РежимСовместимостиСБСП20">2.01</ВерсияФормата>
	<Ид>d8ccfd6c-a781-4c2f-a55a-a40fceffc554    </Ид>
	<Наименование>УправлениеПредприятием --&gt; ЗарплатаИУправлениеПерсоналом (ZEL-204)</Наименование>
	<ДатаВремяСоздания>2022-03-21T01:46:58</ДатаВремяСоздания>
	<Источник ВерсияПлатформы="8.0" ВерсияКонфигурации="2.5.6.195" СинонимКонфигурации="1С:ERP Управление предприятием 2">УправлениеПредприятием</Источник>
	<Приемник ВерсияПлатформы="8.0" ВерсияКонфигурации="3.1.17.171" СинонимКонфигурации="Зарплата и управление персоналом, редакция 3.1">ЗарплатаИУправлениеПерсоналом</Приемник>
	<ПередЗагрузкойДанных>     
Запрос = Новый Запрос;
Запрос.Текст = "ВЫБРАТЬ
				|	*
				|ИЗ
				|	РегистрСведений.бит_ОплатаПитания КАК бит_ОплатаПитания
				|ГДЕ
				|	бит_ОплатаПитания.ПериодЗаписи МЕЖДУ &amp;ДатаНачала И &amp;ДатаОкончания";

Запрос.УстановитьПараметр("ДатаНачала", ДатаНачала);			 
Запрос.УстановитьПараметр("ДатаОкончания", ДатаОкончания);

РезультатЗапроса = Запрос.Выполнить();
Выборка = РезультатЗапроса.Выбрать();

Пока Выборка.Следующий() Цикл
	МенеджерЗаписи = РегистрыСведений.бит_ОплатаПитания.СоздатьМенеджерЗаписи();
	ЗаполнитьЗначенияСвойств(МенеджерЗаписи, Выборка);
	МенеджерЗаписи.Удалить();
КонецЦикла;


</ПередЗагрузкойДанных>
	<Параметры>
		<Параметр Имя="Склад                                             " Наименование="Склад" ИспользуетсяПриЗагрузке="false" УстанавливатьВДиалоге="true" ТипЗначения="СправочникСсылка.Склады" ПередаватьПараметрПриВыгрузке="false"/>
		<Параметр Имя="Склады                                            " Наименование="Склады" ИспользуетсяПриЗагрузке="false" УстанавливатьВДиалоге="true" ТипЗначения="Строка" ПередаватьПараметрПриВыгрузке="false"/>
	</Параметры>
	<Обработки/>
	<ПравилаКонвертацииОбъектов>
		<Правило>
			<Код>бит_ОплатаПитания</Код>
			<Наименование>:</Наименование>
			<Порядок>50</Порядок>
			<ПослеЗагрузки>
Запрос = Новый Запрос;
Запрос.Текст = 
	"ВЫБРАТЬ
	|	бит_КартыСотрудниковСрезПоследних.Сотрудник.Код КАК ТабНомер,
	|	бит_КартыСотрудниковСрезПоследних.Сотрудник КАК Сотрудник
	|ИЗ
	|	РегистрСведений.бит_КартыСотрудников.СрезПоследних(&amp;Дата, Карта = &amp;Карта) КАК бит_КартыСотрудниковСрезПоследних";

Запрос.УстановитьПараметр("Дата", Объект.ПериодЗаписи);
Запрос.УстановитьПараметр("Карта", ПараметрыОбъекта["НомерПлатежнойКарты"]);

РезультатЗапроса = Запрос.Выполнить();
ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
	Объект.Сотрудник = ВыборкаДетальныеЗаписи.Сотрудник;
	Объект.ТабНомер = ВыборкаДетальныеЗаписи.ТабНомер;
КонецЦикла;

Сообщить(Объект.ПериодЗаписи);
Сообщить(ПараметрыОбъекта["НомерПлатежнойКарты"]);
Сообщить(Объект.Сотрудник);
Если Не ЗначениеЗаполнено(Объект.Сотрудник) Тогда
	Сообщить("По номеру карты " + ПараметрыОбъекта["НомерПлатежнойКарты"] + " сотрудник не найден! Запись будет пропущена!");
    Отказ = Истина;
Иначе
	НаборЗаписей = РегистрыСведений.бит_ОплатаПитания.СоздатьНаборЗаписей();
	НаборЗаписей.Отбор.ПериодЗаписи.Установить(Объект.ПериодЗаписи);
	НаборЗаписей.Отбор.Сотрудник.Установить(Объект.Сотрудник);
	НаборЗаписей.Отбор.ОРП.Установить(Объект.ОРП);
	
	НоваяЗапись = НаборЗаписей.Добавить();
	НоваяЗапись.ПериодЗаписи = Объект.ПериодЗаписи;
	НоваяЗапись.Сотрудник = Объект.Сотрудник;
	НоваяЗапись.ТабНомер = Объект.ТабНомер;
	НоваяЗапись.ОРП = Объект.ОРП;
	НоваяЗапись.Сумма = Объект.Сумма;
	НоваяЗапись.Активность = Объект.Активность;
	
	НаборЗаписей.Записать();
КонецЕсли;</ПослеЗагрузки>
			<НеЗапоминатьВыгруженные>true</НеЗапоминатьВыгруженные>
			<Приемник>РегистрСведенийЗапись.бит_ОплатаПитания</Приемник>
			<Свойства>
				<Свойство>
					<Код>1</Код>
					<Наименование>--&gt; ОРП</Наименование>
					<Порядок>50</Порядок>
					<ПолучитьИзВходящихДанных>true</ПолучитьИзВходящихДанных>
					<Источник Имя="" Вид=""/>
					<Приемник Имя="ОРП" Вид="Измерение" Тип="Строка"/>
				</Свойство>
				<Свойство>
					<Код>2</Код>
					<Наименование>--&gt; ПериодЗаписи</Наименование>
					<Порядок>100</Порядок>
					<ПолучитьИзВходящихДанных>true</ПолучитьИзВходящихДанных>
					<Источник Имя="" Вид=""/>
					<Приемник Имя="ПериодЗаписи" Вид="Измерение" Тип="Дата"/>
				</Свойство>
				<Свойство>
					<Код>3</Код>
					<Наименование>--&gt; НомерПлатежнойКарты</Наименование>
					<Порядок>150</Порядок>
					<Источник Имя="" Вид=""/>
					<Приемник Имя="" Вид=""/>
					<ИмяПараметраДляПередачи>НомерПлатежнойКарты</ИмяПараметраДляПередачи>
					<ПередВыгрузкой>Значение = ВходящиеДанные.НомерПлатежнойКарты</ПередВыгрузкой>
				</Свойство>
				<Свойство>
					<Код>4</Код>
					<Наименование>--&gt; ТабНомер</Наименование>
					<Порядок>200</Порядок>
					<Источник Имя="" Вид=""/>
					<Приемник Имя="ТабНомер" Вид="Измерение" Тип="Строка"/>
				</Свойство>
				<Свойство>
					<Код>5</Код>
					<Наименование>--&gt; Сумма</Наименование>
					<Порядок>250</Порядок>
					<ПолучитьИзВходящихДанных>true</ПолучитьИзВходящихДанных>
					<Источник Имя="" Вид=""/>
					<Приемник Имя="Сумма" Вид="Ресурс" Тип="Число"/>
				</Свойство>
				<Свойство>
					<Код>6</Код>
					<Наименование>--&gt; Активность</Наименование>
					<Порядок>300</Порядок>
					<Источник Имя="" Вид=""/>
					<Приемник Имя="Активность" Вид="Свойство" Тип="Булево"/>
					<ПередВыгрузкой>Значение = Истина;</ПередВыгрузкой>
				</Свойство>
			</Свойства>
			<Значения/>
		</Правило>
	</ПравилаКонвертацииОбъектов>
	<ПравилаВыгрузкиДанных>
		<Правило Отключить="false">
			<Код>ОтчетОРозничныхПродажах_ОплатаПитания</Код>
			<Наименование>Отчет о розничных продажах -&gt; Оплата питания</Наименование>
			<Порядок>150</Порядок>
			<СпособОтбораДанных>ПроизвольныйАлгоритм</СпособОтбораДанных>
			<ОбъектВыборки>ДокументСсылка.ОтчетОРозничныхПродажах</ОбъектВыборки>
			<ПередОбработкойПравила>
Запрос = Новый Запрос("ВЫБРАТЬ
|	ОтчетОРозничныхПродажахбитзпф_ОплатаПрочимиТипами.Ссылка.Дата КАК Период,
|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ОтчетОРозничныхПродажахбитзпф_ОплатаПрочимиТипами.Ссылка) КАК ОРП,
|	ОтчетОРозничныхПродажахбитзпф_ОплатаПрочимиТипами.НомерКарты КАК НомерКарты,
|	СУММА(ОтчетОРозничныхПродажахбитзпф_ОплатаПрочимиТипами.Сумма) КАК Сумма
|ИЗ
|	Документ.ОтчетОРозничныхПродажах.битзпф_ОплатаПрочимиТипами КАК ОтчетОРозничныхПродажахбитзпф_ОплатаПрочимиТипами
|ГДЕ
|	ОтчетОРозничныхПродажахбитзпф_ОплатаПрочимиТипами.Ссылка.Дата МЕЖДУ &amp;ДатаНачала И &amp;ДатаОкончания
|	И ОтчетОРозничныхПродажахбитзпф_ОплатаПрочимиТипами.Ссылка.Проведен
|	И ОтчетОРозничныхПродажахбитзпф_ОплатаПрочимиТипами.Ссылка.Склад В ИЕРАРХИИ(&amp;Склады)
|
|СГРУППИРОВАТЬ ПО
|	ОтчетОРозничныхПродажахбитзпф_ОплатаПрочимиТипами.Ссылка,
|	ОтчетОРозничныхПродажахбитзпф_ОплатаПрочимиТипами.Ссылка.Дата,
|	ОтчетОРозничныхПродажахбитзпф_ОплатаПрочимиТипами.НомерКарты,
|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ОтчетОРозничныхПродажахбитзпф_ОплатаПрочимиТипами.Ссылка)");

Запрос.УстановитьПараметр("Склады", ЗначениеИзСтрокиВнутр(Параметры.Склады));
Запрос.УстановитьПараметр("ДатаНачала", ДатаНачала);
Запрос.УстановитьПараметр("ДатаОкончания", ДатаОкончания);

Выборка = Запрос.Выполнить().Выбрать();
Пока Выборка.Следующий() Цикл
	Если ЗначениеЗаполнено(Выборка.НомерКарты) Тогда
		ВходящиеДанные = Новый Структура("ПериодЗаписи, ОРП, НомерПлатежнойКарты, Сумма", Выборка.Период, Выборка.ОРП, Выборка.НомерКарты, Выборка.Сумма);
		ВыгрузитьПоПравилу( , , ВходящиеДанные, , "бит_ОплатаПитания");
	КонецЕсли;
КонецЦикла;</ПередОбработкойПравила>
		</Правило>
	</ПравилаВыгрузкиДанных>
	<ПравилаОчисткиДанных/>
	<Алгоритмы>
		<Алгоритм Имя="СоздатьЗаписьРегистраОплатаПитания" ИспользуетсяПриЗагрузке="true"/>
	</Алгоритмы>
	<Запросы/>
</ПравилаОбмена>